@using System.Reflection
@using Portfolio.BlazorApp.Data.Models

<div class="card h-100">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@Data.TableName</h5>

        @if (CanAdd)
        {
            <button class="btn btn-sm btn-primary" @onclick="OnAddClicked">Add</button>
        }
    </div>

    <div class="card-body">
        @if (!Data.Rows.Any())
        {
            <p class="text-muted">No data.</p>
        }
        else
        {
            PropertyInfo[] properties = Data.ItemType.GetProperties();
            <div class="table-responsive db-table-scroll">
                <table class="table table-sm table-striped">
                    <thead>
                    <tr>
                        @foreach (PropertyInfo prop in properties)
                        {
                            <th>@prop.Name</th>
                        }

                        @if (CanEdit || CanDelete)
                        {
                            <th>Actions</th>
                        }
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (object row in Data.Rows)
                    {
                        <tr>
                            @foreach (PropertyInfo property in properties)
                            {
                                object? value = property.GetValue(row);
                                Type propertyType = property.PropertyType;

                                if (typeof(System.Collections.IEnumerable).IsAssignableFrom(propertyType)
                                    && propertyType != typeof(string))
                                {
                                    <td>Collection</td>
                                }
                                else
                                {
                                    <td>@value</td>
                                }
                            }

                            @if (CanEdit || CanDelete)
                            {
                                <td>
                                    @if (CanEdit)
                                    {
                                        <button class="btn btn-sm btn-outline-secondary me-1"
                                                @onclick="() => EditClicked(row)">
                                            Edit
                                        </button>
                                    }
                                    @if (CanDelete)
                                    {
                                        <button class="btn btn-sm btn-outline-danger"
                                                @onclick="() => DeleteClicked(row)">
                                            Delete
                                        </button>
                                    }
                                </td>
                            }
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public TableData Data { get; set; } = default!;

    // Callbacks for CRUD
    [Parameter] public EventCallback<Type> OnAdd { get; set; }
    [Parameter] public EventCallback<object> OnEdit { get; set; }
    [Parameter] public EventCallback<object> OnDelete { get; set; }

    private bool CanAdd => OnAdd.HasDelegate;
    private bool CanEdit => OnEdit.HasDelegate;
    private bool CanDelete => OnDelete.HasDelegate;

    private Task OnAddClicked() => OnAdd.InvokeAsync(Data.ItemType);
    private Task EditClicked(object row) => OnEdit.InvokeAsync(row);
    private Task DeleteClicked(object row) => OnDelete.InvokeAsync(row);
}
